<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Super Admin - Season Control</title>
    <style>
        body { background: #000; color: #fff; font-family: sans-serif; padding: 20px; }
        .container { max-width: 700px; margin: 0 auto; }
        
        /* LIVE STATUS */
        .live-card { 
            border: 2px solid #333; background: #111; padding: 20px; 
            text-align: center; border-radius: 10px; margin-bottom: 20px;
        }
        .live-card.active { border-color: #0f0; background: #051a05; }
        .live-blink { animation: blink 1s infinite; color: #0f0; font-weight: bold; }
        @keyframes blink { 50% { opacity: 0; } }

        /* FORM */
        .box { background: #1a1a1a; padding: 15px; border-radius: 8px; margin-bottom: 15px; }
        input { background: #333; color: #fff; border: 1px solid #555; padding: 8px; width: 45%; margin-bottom: 10px; }
        label { color: #aaa; font-size: 0.8rem; display: block; }
        
        button { cursor: pointer; padding: 10px; border: none; border-radius: 4px; font-weight: bold; }
        .btn-create { background: #D4AF37; width: 100%; }
        
        /* LIST BUTTONS */
        .season-row { display: flex; justify-content: space-between; background: #222; padding: 10px; margin-top: 5px; border-left: 3px solid #555; align-items: center; }
        .btn-green { background: #0a0; color: #fff; font-size: 0.8rem; padding: 5px 10px; }
        .btn-blue { background: #00a; color: #fff; font-size: 0.8rem; padding: 5px 10px; }
        .btn-red { background: #a00; color: #fff; font-size: 0.8rem; padding: 5px 10px; }

    </style>
</head>
<body>

    <div class="container">
        <h2 style="text-align:center; color:#D4AF37">‚ö° INSTANT SEASON CONTROL</h2>

        <!-- 1. LIVE MONITOR -->
        <div id="statusBox" class="live-card">
            <h3>üî¥ NO GAME RUNNING</h3>
            <p>Users verify "Season Ended" screen.</p>
        </div>

        <!-- 2. CREATE -->
        <div class="box">
            <h3 style="margin-top:0; color:#D4AF37">Create Season</h3>
            <input type="text" id="sName" placeholder="Season Name (e.g. Round 1)" style="width:96%">
            
            <label>Start (Date & Time)</label>
            <input type="date" id="sDate"> <input type="time" id="sTime">
            
            <label>End (Date & Time)</label>
            <input type="date" id="eDate"> <input type="time" id="eTime">
            
            <label>Question Limit</label>
            <input type="number" id="limit" placeholder="10" style="width:96%">

            <button class="btn-create" onclick="createSeason()">SAVE TO LIST</button>
        </div>

        <!-- 3. LIST -->
        <h3>All Seasons</h3>
        <div id="listArea">Loading...</div>

        <br>
        <button onclick="stopGame()" style="background:#444; color:#fff; width:100%; padding:15px;">üõë STOP EVERYTHING (Emergency)</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getDatabase, ref, push, onValue, set, remove, get } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

        const firebaseConfig = { apiKey: "AIzaSyDKO9G5GLdHk5D_UCzDx-A76yb80zvesJ4", authDomain: "quiz-55a8d.firebaseapp.com", databaseURL: "https://quiz-55a8d-default-rtdb.firebaseio.com", projectId: "quiz-55a8d", storageBucket: "quiz-55a8d.firebasestorage.app", messagingSenderId: "745030366382", appId: "1:745030366382:web:25d6210f97391136d5693f" };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- 1. MONITOR LIVE STATUS ---
        onValue(ref(db, 'game_settings'), (snap) => {
            const val = snap.val();
            const box = document.getElementById('statusBox');
            
            if(val && val.seasonName) {
                box.className = "live-card active";
                box.innerHTML = `
                    <h3><span class="live-blink">‚óè LIVE NOW</span>: ${val.seasonName}</h3>
                    <p>End Time: ${val.endTime}</p>
                    <small>Game ID: ${val.active_season_id}</small>
                `;
            } else {
                box.className = "live-card";
                box.innerHTML = `<h3>üî¥ GAME STOPPED</h3><p>Select a season below to start.</p>`;
            }
        });

        // --- 2. LOAD LIST ---
        let allSeasons = {};
        onValue(ref(db, 'seasons_list'), (snap) => {
            allSeasons = snap.val() || {};
            const area = document.getElementById('listArea');
            area.innerHTML = "";
            
            Object.keys(allSeasons).reverse().forEach(key => {
                const s = allSeasons[key];
                const div = document.createElement('div');
                div.className = 'season-row';
                div.innerHTML = `
                    <div>
                        <strong style="color:#D4AF37">${s.seasonName}</strong><br>
                        <small style="color:#888">${s.startDate} ${s.startTime} ‚Æï ${s.endTime}</small>
                    </div>
                    <div style="display:flex; flex-direction:column; gap:5px;">
                        <button class="btn-green" onclick="forceStart('${key}')">‚ö° START NOW</button>
                        <button class="btn-blue" onclick="activateNormal('${key}')">Use Original Time</button>
                        <button class="btn-red" onclick="deleteS('${key}')">Del</button>
                    </div>
                `;
                area.appendChild(div);
            });
        });

        // --- 3. FUNCTIONS ---

        window.createSeason = () => {
            const data = {
                seasonName: document.getElementById('sName').value,
                startDate: document.getElementById('sDate').value,
                startTime: document.getElementById('sTime').value,
                endDate: document.getElementById('eDate').value,
                endTime: document.getElementById('eTime').value,
                maxQuestions: parseInt(document.getElementById('limit').value) || 10
            };
            if(!data.seasonName || !data.startDate) return alert("Fill data properly!");
            push(ref(db, 'seasons_list'), data);
            alert("Saved!");
        }

        // OPTION A: MAGIC BUTTON (Start NOW)
        // ‡¶è‡¶ü‡¶æ‡¶§‡ßá ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡¶≤‡ßá ‡¶Ü‡¶ó‡ßá‡¶∞ ‡¶ü‡¶æ‡¶á‡¶Æ ‡¶Ø‡¶æ‡¶á ‡¶•‡¶æ‡¶ï‡ßÅ‡¶ï, ‡¶∏‡ßá‡¶ü‡¶æ ‡¶™‡¶æ‡¶≤‡ßç‡¶ü‡ßá '‡¶è‡¶ñ‡¶®' ‡¶ï‡¶∞‡ßá ‡¶¶‡ßá‡¶¨‡ßá‡•§
        window.forceStart = (key) => {
            if(!confirm("Start this season IMMEDIATELY? (I will update Start Time to NOW)")) return;

            const s = allSeasons[key];
            const now = new Date();
            const oneHourLater = new Date(now.getTime() + 60*60*1000); // 1 Hour Game

            // Format Dates for HTML Inputs/Display (YYYY-MM-DD)
            const yyyy = now.getFullYear();
            const mm = String(now.getMonth()+1).padStart(2,'0');
            const dd = String(now.getDate()).padStart(2,'0');
            
            const hh = String(now.getHours()).padStart(2,'0');
            const min = String(now.getMinutes()).padStart(2,'0');

            // Update the object
            s.startDate = `${yyyy}-${mm}-${dd}`;
            s.startTime = `${hh}:${min}`; // Start NOW
            
            // End time 1 hour later
            s.endDate = `${yyyy}-${mm}-${dd}`;
            s.endTime = `${oneHourLater.getHours()}:${String(oneHourLater.getMinutes()).padStart(2,'0')}`;
            s.active_season_id = key;

            // 1. Reset Users?
            if(confirm("Reset all player scores to 0?")) {
                get(ref(db, 'users')).then(snap => {
                    if(snap.exists()) {
                        const updates = {};
                        snap.forEach(u => {
                            updates[`users/${u.key}/score`] = 0;
                            updates[`users/${u.key}/answered_questions`] = null;
                            updates[`users/${u.key}/nextAvailableTime`] = 0;
                        });
                        updates['game_settings'] = s; // Set game live same time
                        return update(ref(db), updates);
                    } else {
                        return set(ref(db, 'game_settings'), s);
                    }
                }).then(() => alert("Started! Check Live Box."));
            } else {
                // Just start without reset
                set(ref(db, 'game_settings'), s);
            }
        }

        // OPTION B: Normal Activate (Uses your set time)
        window.activateNormal = (key) => {
            const s = allSeasons[key];
            s.active_season_id = key;
            
            if(confirm("Reset scores?")) {
                // Logic same as above for reset
                get(ref(db, 'users')).then(snap => {
                    const updates = {};
                    if(snap.exists()) {
                        snap.forEach(u => {
                            updates[`users/${u.key}/score`] = 0;
                            updates[`users/${u.key}/answered_questions`] = null;
                        });
                    }
                    updates['game_settings'] = s;
                    update(ref(db), updates);
                });
            } else {
                set(ref(db, 'game_settings'), s);
            }
        }

        window.deleteS = (key) => {
            if(confirm("Delete?")) remove(ref(db, `seasons_list/${key}`));
        }

        window.stopGame = () => {
            remove(ref(db, 'game_settings'));
        }

        // Helper for update
        window.update = update;
    </script>
</body>
</html>
