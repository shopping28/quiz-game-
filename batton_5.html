<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Super Admin - Season Manager</title>
    <style>
        body { background: #000; color: #fff; font-family: sans-serif; padding: 20px; }
        .container { max-width: 600px; margin: 0 auto; }
        
        /* LIVE STATUS CARD */
        .live-box { 
            border: 2px solid #0f0; background: #0a1a0a; 
            padding: 20px; text-align: center; border-radius: 10px; margin-bottom: 30px; 
        }
        .live-box.inactive { border-color: #333; background: #111; color: #555; }

        /* FORM */
        .input-box { background: #161616; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        input { width: 100%; padding: 10px; margin: 5px 0 15px 0; background: #222; color: #fff; border: 1px solid #444; box-sizing: border-box; }
        
        button { cursor: pointer; padding: 10px; font-weight: bold; border-radius: 5px; border: none; }
        .btn-add { background: #D4AF37; width: 100%; color: #000; }
        .btn-live { background: #0f0; color: #000; margin-right: 5px; }
        .btn-del { background: #f00; color: #fff; }

        /* LIST */
        .season-row { 
            display: flex; justify-content: space-between; align-items: center; 
            background: #222; padding: 15px; margin-bottom: 10px; border-radius: 5px; border-left: 5px solid #555; 
        }
        .season-row.active { border-left-color: #0f0; background: #0f1a0f; }

        .btn-reset { 
            background: #500; color: #faa; width: 100%; margin-top: 20px; padding: 15px;
        }
    </style>
</head>
<body>

    <div class="container">
        <h2 style="text-align:center; color:#D4AF37">SEASON CONTROLLER</h2>

        <!-- 1. LIVE STATUS -->
        <div id="liveStatusBox" class="live-box inactive">
            <h3 id="liveTitle">NO SEASON ACTIVE</h3>
            <p id="liveTime">The game is currently stopped.</p>
            <button onclick="stopGame()" style="background:#333; color:#fff; border:1px solid #555; margin-top:10px;">STOP GAME MANUALLY</button>
        </div>

        <!-- 2. CREATE NEW -->
        <div class="input-box">
            <h3 style="color:#D4AF37; margin-top:0;">Create New Season</h3>
            
            <label>Season Name (e.g. Morning Round)</label>
            <input type="text" id="sName" placeholder="Enter Name">

            <div style="display:flex; gap:10px;">
                <div style="flex:1"><label>Start Date</label><input type="date" id="sDate"></div>
                <div style="flex:1"><label>Start Time</label><input type="time" id="sTime"></div>
            </div>
            
            <div style="display:flex; gap:10px;">
                <div style="flex:1"><label>End Date</label><input type="date" id="eDate"></div>
                <div style="flex:1"><label>End Time</label><input type="time" id="eTime"></div>
            </div>

            <label>Question Limit</label>
            <input type="number" id="qLimit" placeholder="10">

            <button class="btn-add" onclick="addSeason()">ADD TO LIST</button>
        </div>

        <!-- 3. LIST -->
        <h3 style="color:#888">Season History</h3>
        <div id="listArea">Loading...</div>

        <!-- 4. MANUAL RESET -->
        <button class="btn-reset" onclick="resetPlayers()">âš  RESET ALL PLAYER SCORES (Clean Start)</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getDatabase, ref, push, onValue, update, remove, get } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

        const firebaseConfig = { apiKey: "AIzaSyDKO9G5GLdHk5D_UCzDx-A76yb80zvesJ4", authDomain: "quiz-55a8d.firebaseapp.com", databaseURL: "https://quiz-55a8d-default-rtdb.firebaseio.com", projectId: "quiz-55a8d", storageBucket: "quiz-55a8d.firebasestorage.app", messagingSenderId: "745030366382", appId: "1:745030366382:web:25d6210f97391136d5693f" };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        let activeID = null;
        let allSeasons = {};

        // --- MONITOR LIVE STATUS ---
        onValue(ref(db, 'game_settings'), (snap) => {
            const val = snap.val();
            const box = document.getElementById('liveStatusBox');
            
            if (val && val.seasonName) {
                // Game is Running
                activeID = val.active_season_id;
                box.className = "live-box"; // Green border
                document.getElementById('liveTitle').innerText = "âœ… LIVE: " + val.seasonName;
                document.getElementById('liveTime').innerText = `Ends: ${val.endDate} at ${val.endTime}`;
            } else {
                // Game is Stopped
                activeID = null;
                box.className = "live-box inactive";
                document.getElementById('liveTitle').innerText = "ðŸ”´ NO SEASON ACTIVE";
                document.getElementById('liveTime').innerText = "Game is closed for users.";
            }
            renderList();
        });

        // --- MONITOR LIST ---
        onValue(ref(db, 'seasons_list'), (snap) => {
            allSeasons = snap.val() || {};
            renderList();
        });

        function renderList() {
            const div = document.getElementById('listArea');
            div.innerHTML = "";
            
            const keys = Object.keys(allSeasons).reverse();
            if(keys.length === 0) {
                div.innerHTML = "<p>No seasons found.</p>";
                return;
            }

            keys.forEach(k => {
                const s = allSeasons[k];
                const isActive = (k === activeID);
                
                const row = document.createElement('div');
                row.className = `season-row ${isActive ? 'active' : ''}`;
                row.innerHTML = `
                    <div>
                        <strong>${s.seasonName}</strong><br>
                        <small>${s.startTime} - ${s.endTime}</small>
                    </div>
                    <div>
                        ${!isActive ? `<button class="btn-live" onclick="goLive('${k}')">ACTIVATE</button>` : '<span style="color:#0f0; margin-right:10px; font-weight:bold;">LIVE</span>'}
                        <button class="btn-del" onclick="delSeason('${k}')">DELETE</button>
                    </div>
                `;
                div.appendChild(row);
            });
        }

        // --- FUNCTIONS ---

        // 1. ADD SEASON
        window.addSeason = () => {
            const data = {
                seasonName: document.getElementById('sName').value,
                startDate: document.getElementById('sDate').value,
                startTime: document.getElementById('sTime').value,
                endDate: document.getElementById('eDate').value,
                endTime: document.getElementById('eTime').value,
                maxQuestions: document.getElementById('qLimit').value || 10
            };
            if(!data.seasonName || !data.startDate) return alert("Please fill details");
            
            push(ref(db, 'seasons_list'), data);
            alert("Season Added!");
        }

        // 2. ACTIVATE (GO LIVE) - WITH AUTO RESET CHECK
        window.goLive = (key) => {
            const s = allSeasons[key];
            
            // Ask admin if they want to clear old scores
            let doReset = confirm("Do you want to RESET all player scores for this new season?\n\nOK = Yes, Reset Scores (Players start fresh)\nCancel = No, Keep Scores");

            const updates = {};
            // Set new game settings
            updates['game_settings'] = s;
            updates['game_settings/active_season_id'] = key;

            if(doReset) {
                // If yes, we prepare to clear users
                resetPlayers(true).then(() => {
                    update(ref(db), updates); // Then update season
                });
            } else {
                update(ref(db), updates); // Just update season
            }
        }

        // 3. DELETE SEASON (SMART DELETE)
        window.delSeason = (key) => {
            if(!confirm("Delete this season?")) return;

            // If we are deleting the CURRENTLY LIVE season, stop the game first
            if(key === activeID) {
                remove(ref(db, 'game_settings')); // This stops the game instantly
            }
            
            // Remove from history list
            remove(ref(db, `seasons_list/${key}`));
        }

        // 4. STOP GAME MANUALLY
        window.stopGame = () => {
            if(confirm("Stop the current game? Users will see 'Season Ended'.")) {
                remove(ref(db, 'game_settings'));
            }
        }

        // 5. RESET PLAYERS LOGIC
        window.resetPlayers = async (silent = false) => {
            if(!silent && !confirm("WARNING: This will delete ALL user scores and history. Proceed?")) return;

            const snap = await get(ref(db, 'users'));
            if(snap.exists()) {
                const updates = {};
                snap.forEach(u => {
                    updates[`users/${u.key}/score`] = 0;
                    updates[`users/${u.key}/answered_questions`] = null;
                    updates[`users/${u.key}/nextAvailableTime`] = 0;
                });
                await update(ref(db), updates);
                if(!silent) alert("All players reset to 0.");
            } else {
                if(!silent) alert("No users found.");
            }
        }

        // Make global
        window.addSeason = addSeason;
        window.goLive = goLive;
        window.delSeason = delSeason;
        window.stopGame = stopGame;
        window.resetPlayers = resetPlayers;

    </script>
</body>
</html>
